<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PigmentPro | Advanced Scientific Color Formulation System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        .color-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .formula-card {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(5px);
        }
        .color-input {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 48px;
            background: transparent;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 0;
            cursor: pointer;
        }
        .color-input::-webkit-color-swatch {
            border-radius: 6px;
            border: none;
        }
        .color-input::-moz-color-swatch {
            border-radius: 6px;
            border: none;
        }
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #e2e8f0;
        }
        ::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 3px;
        }
        .formula-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }
        .formula-table th, .formula-table td {
            padding: 10px 8px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
            vertical-align: top;
        }
        .formula-table th {
            font-size: 0.75rem;
            font-weight: 600;
            background-color: #f8fafc;
            color: #374151;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .loading-spinner {
            border: 3px solid rgba(0,0,0,0.1);
            border-radius: 50%;
            border-top: 3px solid #3b82f6;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .copyright-notice {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 16px;
            font-size: 0.75rem;
            text-align: center;
            margin-bottom: 1rem;
            border-radius: 8px;
        }
        .indian-supplier {
            color: #10b981;
            font-weight: 500;
            font-size: 0.8em;
        }
        .chemical-formula {
            font-family: 'Courier New', monospace;
            background: #f1f5f9;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 0.8em;
            color: #1e40af;
        }
        .process-step {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 8px 12px;
            margin: 4px 0;
            border-radius: 0 4px 4px 0;
        }
        .component-category {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .component-category td {
            border-bottom: 2px solid #1e40af;
            text-align: center;
            padding: 12px 8px;
        }
        .percentage-display {
            font-weight: 600;
            color: #059669;
            background: #ecfdf5;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.8em;
        }
        .weight-display {
            font-weight: 600;
            color: #7c3aed;
            font-family: 'Courier New', monospace;
        }
        .function-text {
            color: #6b7280;
            font-style: italic;
            line-height: 1.3;
        }
        .supplier-text {
            color: #059669;
            font-weight: 500;
            font-size: 0.8em;
            line-height: 1.2;
        }
        .grade-text {
            color: #dc2626;
            font-size: 0.75em;
            background: #fef2f2;
            padding: 2px 4px;
            border-radius: 3px;
        }
        .formula-container {
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
        }
        .color-analysis {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
        }
        .scientific-note {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 8px 12px;
            font-size: 0.85em;
            font-style: italic;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50">
    <!-- Copyright Notice -->
    <div class="copyright-notice">
        Â© 2024 Dr. Yash M Gupta | PigmentPro Advanced Scientific Formulation System | Precision Color Chemistry
    </div>

    <div class="container mx-auto px-4 py-6">
        <!-- Header -->
        <header class="mb-8">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl md:text-3xl font-semibold tracking-tight">
                        <span class="text-blue-600">Pigment</span><span class="text-indigo-600">Pro</span>
                        <span class="text-xs text-gray-500 ml-2">Advanced Scientific System by Dr. Yash M Gupta</span>
                    </h1>
                    <p class="mt-1 text-sm opacity-60">Scientific Grade Color Formulation System v8.0.0 | Precision Chemistry | Shade-Specific Calculations</p>
                </div>
                <div class="text-xs md:text-sm opacity-70">
                    <span id="datetime" class="font-mono">2025-06-03 03:28:44 UTC</span>
                </div>
            </div>
        </header>

        <!-- Main App -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Color Input Section -->
            <div class="lg:col-span-2 space-y-6">
                <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                    <h2 class="text-lg font-medium mb-4 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-6m-4 4h12v4a4 4 0 01-4 4H5a4 4 0 01-4-4v-4z" />
                        </svg>
                        Scientific Color Analysis & Parameters
                    </h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div>
                            <label class="block text-sm mb-1 opacity-70">Target Color</label>
                            <input type="color" id="baseColor" value="#dc2626" class="color-input">
                        </div>
                        <div>
                            <label class="block text-sm mb-1 opacity-70">Application Type</label>
                            <select id="applicationType" class="w-full border border-gray-200 rounded px-3 py-2 text-sm">
                                <option value="emulsion_paint">Emulsion Paint</option>
                                <option value="enamel_paint">Enamel Paint</option>
                                <option value="automotive_paint">Automotive Paint</option>
                                <option value="textile_printing">Textile Printing</option>
                                <option value="plastic_masterbatch">Plastic Masterbatch</option>
                                <option value="printing_ink">Printing Ink</option>
                                <option value="cosmetic_color">Cosmetic Color</option>
                                <option value="ceramic_glaze">Ceramic Glaze</option>
                                <option value="industrial_coating">Industrial Coating</option>
                                <option value="powder_coating">Powder Coating</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm mb-1 opacity-70">Batch Size (kg)</label>
                            <select id="batchSize" class="w-full border border-gray-200 rounded px-3 py-2 text-sm">
                                <option value="1">1 kg (Lab Scale)</option>
                                <option value="10">10 kg (Pilot Scale)</option>
                                <option value="100">100 kg (Production)</option>
                                <option value="1000">1000 kg (Industrial)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm mb-1 opacity-70">Quality Grade</label>
                            <select id="qualityGrade" class="w-full border border-gray-200 rounded px-3 py-2 text-sm">
                                <option value="economy">Economy Grade</option>
                                <option value="standard">Standard Grade</option>
                                <option value="premium">Premium Grade</option>
                                <option value="super_premium">Super Premium</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 md:grid-cols-6 gap-3">
                        <button id="formulateBtn" class="bg-blue-600 hover:bg-blue-500 text-white py-2 px-4 rounded text-sm transition shadow-sm flex items-center justify-center">
                            <span id="formulateText">Calculate</span>
                            <span id="formulateSpinner" class="loading-spinner ml-2 hidden"></span>
                        </button>
                        <button id="randomBtn" class="bg-gray-600 hover:bg-gray-500 text-white py-2 px-4 rounded text-sm transition shadow-sm">
                            Random Color
                        </button>
                        <button id="saveBtn" class="border border-gray-300 hover:bg-gray-100 text-gray-700 py-2 px-4 rounded text-sm transition shadow-sm">
                            Save Formula
                        </button>
                        <button id="resetBtn" class="border border-gray-300 hover:bg-gray-100 text-gray-700 py-2 px-4 rounded text-sm transition shadow-sm">
                            Reset
                        </button>
                        <button id="printBtn" class="border border-gray-300 hover:bg-gray-100 text-gray-700 py-2 px-4 rounded text-sm transition shadow-sm">
                            Print Report
                        </button>
                        <button id="exportBtn" class="border border-gray-300 hover:bg-gray-100 text-gray-700 py-2 px-4 rounded text-sm transition shadow-sm">
                            Export JSON
                        </button>
                    </div>
                </div>

                <!-- Scientific Color Analysis -->
                <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                    <h2 class="text-lg font-medium mb-4 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-purple-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                        </svg>
                        Scientific Color Analysis
                    </h2>
                    
                    <div id="colorAnalysis" class="color-analysis">
                        <!-- Scientific analysis will be displayed here -->
                    </div>
                    
                    <div class="grid grid-cols-2 md:grid-cols-6 gap-4 mb-4">
                        <div>
                            <p class="text-xs opacity-50">HEX Code</p>
                            <p id="hexValue" class="font-mono">#dc2626</p>
                        </div>
                        <div>
                            <p class="text-xs opacity-50">RGB Values</p>
                            <p id="rgbValue" class="font-mono">220, 38, 38</p>
                        </div>
                        <div>
                            <p class="text-xs opacity-50">HSL Values</p>
                            <p id="hslValue" class="font-mono">0Â°, 70%, 51%</p>
                        </div>
                        <div>
                            <p class="text-xs opacity-50">LAB Values</p>
                            <p id="labValue" class="font-mono">L:48 a:68 b:47</p>
                        </div>
                        <div>
                            <p class="text-xs opacity-50">Color Strength</p>
                            <p id="colorStrength" class="font-mono">High (85%)</p>
                        </div>
                        <div>
                            <p class="text-xs opacity-50">Chroma</p>
                            <p id="chromaValue" class="font-mono">82.8</p>
                        </div>
                    </div>
                </div>
                
                <!-- Complete Formulation Display -->
                <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                    <h2 class="text-lg font-medium mb-4 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        Scientific Formulation - Shade-Specific Calculations
                    </h2>
                    
                    <div class="scientific-note mb-4">
                        <strong>Scientific Note:</strong> This formulation is precisely calculated based on color science principles, 
                        including Kubelka-Munk theory, chromatic adaptation, and pigment interaction coefficients for the specific shade and application.
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                        <div>
                            <p class="text-xs opacity-50">Total Weight</p>
                            <p id="totalWeight" class="font-mono">1000g</p>
                        </div>
                        <div>
                            <p class="text-xs opacity-50">Solid Content</p>
                            <p id="solidContent" class="font-mono">65%</p>
                        </div>
                        <div>
                            <p class="text-xs opacity-50">Pigment Load</p>
                            <p id="pigmentLoad" class="font-mono">18.5%</p>
                        </div>
                        <div>
                            <p class="text-xs opacity-50">Color Accuracy</p>
                            <p id="colorAccuracy" class="font-mono">ÎE < 1.0</p>
                        </div>
                        <div>
                            <p class="text-xs opacity-50">Shade Class</p>
                            <p id="shadeClass" class="font-mono">Deep Red</p>
                        </div>
                    </div>
                    
                    <div id="formulaContainer" class="mt-4 p-4 rounded-lg formula-card border border-gray-200">
                        <div class="formula-container">
                            <table class="formula-table">
                                <thead>
                                    <tr>
                                        <th style="width: 15%;">Component Name</th>
                                        <th style="width: 12%;">Chemical Formula</th>
                                        <th style="width: 15%;">Indian Supplier</th>
                                        <th style="width: 10%;">Weight (g)</th>
                                        <th style="width: 8%;">Percentage</th>
                                        <th style="width: 20%;">Function</th>
                                        <th style="width: 12%;">Grade/Spec</th>
                                        <th style="width: 8%;">Cost (â¹)</th>
                                    </tr>
                                </thead>
                                <tbody id="formulaContent">
                                    <!-- Complete formula will be generated here -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div id="formulaSummary" class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                            <!-- Formula summary will be added here -->
                        </div>
                        
                        <div id="formulaNotes" class="mt-4 text-sm space-y-2">
                            <!-- Additional technical notes will be added here -->
                        </div>
                    </div>
                </div>
                
                <!-- Manufacturing Process -->
                <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                    <h2 class="text-lg font-medium mb-4 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-orange-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 14.85a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517" />
                        </svg>
                        Shade-Specific Manufacturing Process
                    </h2>
                    <div id="manufacturingProcess" class="space-y-2">
                        <!-- Detailed process steps will be generated here -->
                    </div>
                </div>
                
                <!-- Quality Control Parameters -->
                <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                    <h2 class="text-lg font-medium mb-4 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        Quality Control & Testing Parameters
                    </h2>
                    <div id="qualityControl" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <!-- QC parameters will be generated here -->
                    </div>
                </div>
            </div>
            
            <!-- Right Sidebar -->
            <div class="lg:col-span-1 space-y-6">
                <!-- Recent Formulations -->
                <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-medium flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6H4v-6z" />
                            </svg>
                            Recent Formulations
                        </h2>
                        <span id="paletteCount" class="text-xs bg-gray-100 px-2 py-1 rounded">0 colors</span>
                    </div>
                    
                    <div id="colorPalette" class="space-y-3">
                        <p class="text-sm text-gray-500">No recent formulations yet</p>
                    </div>
                </div>
                
                <!-- Scientific Database -->
                <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                    <h2 class="text-lg font-medium mb-4 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-purple-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                        </svg>
                        Scientific Database
                    </h2>
                    
                    <div class="space-y-4">
                        <div>
                            <h3 class="text-sm font-medium mb-2">Advanced Capabilities</h3>
                            <div class="grid grid-cols-1 gap-2 text-xs">
                                <div class="flex items-center justify-between">
                                    <span class="flex items-center">
                                        <span class="w-2 h-2 rounded-full bg-blue-500 mr-2"></span>
                                        <span>Shade-Specific Calculations</span>
                                    </span>
                                    <span class="text-gray-500">Active</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="flex items-center">
                                        <span class="w-2 h-2 rounded-full bg-green-500 mr-2"></span>
                                        <span>Color Science Engine</span>
                                    </span>
                                    <span class="text-gray-500">v8.0.0</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="flex items-center">
                                        <span class="w-2 h-2 rounded-full bg-yellow-500 mr-2"></span>
                                        <span>Kubelka-Munk Theory</span>
                                    </span>
                                    <span class="text-gray-500">Enabled</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="flex items-center">
                                        <span class="w-2 h-2 rounded-full bg-purple-500 mr-2"></span>
                                        <span>Pigment Interactions</span>
                                    </span>
                                    <span class="text-gray-500">Calculated</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="pt-2 border-t border-gray-200">
                            <h3 class="text-sm font-medium mb-2">System Status</h3>
                            <div class="flex justify-between text-sm mb-1">
                                <span class="opacity-70">Database:</span>
                                <span class="text-green-600 font-mono">Connected</span>
                            </div>
                            <div class="flex justify-between text-sm mb-1">
                                <span class="opacity-70">Color Engine:</span>
                                <span class="text-green-600 font-mono">Active</span>
                            </div>
                            <div class="flex justify-between text-sm mb-1">
                                <span class="opacity-70">User:</span>
                                <span class="text-blue-600 font-mono">yashmgupta</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="opacity-70">Security:</span>
                                <span class="text-green-600 font-mono">AES-256</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Console -->
        <div class="mt-8 bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
            <div class="flex items-center mb-2">
                <div class="flex space-x-2 mr-3">
                    <span class="w-3 h-3 rounded-full bg-red-500"></span>
                    <span class="w-3 h-3 rounded-full bg-yellow-500"></span>
                    <span class="w-3 h-3 rounded-full bg-green-500"></span>
                </div>
                <span class="text-sm opacity-70">PIGMENTPRO SCIENTIFIC FORMULATION CONSOLE</span>
                <span class="ml-auto text-xs bg-gray-100 px-2 py-1 rounded">Live Updates | Dr. Yash M Gupta | yashmgupta</span>
            </div>
            <div id="console" class="font-mono text-sm h-28 overflow-y-auto p-2 bg-gray-50 rounded">
                <p>> PigmentPro Scientific Formulation System initialized at 2025-06-03 03:28:44 UTC</p>
                <p>> Advanced color science engine loaded successfully</p>
                <p>> Shade-specific calculation algorithms ready</p>
                <p>> User yashmgupta authenticated successfully</p>
                <p>> Kubelka-Munk color matching engine active</p>
                <p>> Ready for precision color formulation...</p>
            </div>
        </div>
    </div>

    <script>
        // Advanced Scientific Color Database with detailed pigment properties
        const scientificColorDatabase = {
            // Enhanced pigment database with scientific properties
            pigments: {
                white: [
                    {
                        name: "Titanium Dioxide (Rutile)",
                        chemFormula: "TiOâ",
                        indianSuppliers: ["Travancore Titanium Products", "Karnataka Pigments Corporation"],
                        grades: ["R-5566 DuPont", "TR-92 Tronox", "R-706 Chemours"],
                        pricePerKg: 185,
                        scatteringCoefficient: 1420, // S value in Kubelka-Munk
                        absorptionCoefficient: 0.05, // K value
                        refractiveIndex: 2.76,
                        massTintingStrength: 1900,
                        properties: { opacity: 98, brightness: 99, density: 4.23, oilAbsorption: 18 }
                    },
                    {
                        name: "Zinc Oxide",
                        chemFormula: "ZnO",
                        indianSuppliers: ["Hindustan Zinc Ltd", "Zinc National"],
                        grades: ["Kadox 930", "French Process"],
                        pricePerKg: 165,
                        scatteringCoefficient: 540,
                        absorptionCoefficient: 0.08,
                        refractiveIndex: 2.02,
                        massTintingStrength: 780,
                        properties: { opacity: 85, brightness: 95, density: 5.61, oilAbsorption: 20 }
                    }
                ],
                red: [
                    {
                        name: "Iron Oxide Red (Light)",
                        chemFormula: "FeâOâ",
                        indianSuppliers: ["Lanxess India", "Cathay Pigments India"],
                        grades: ["PR101 Light", "Bayferrox 110M"],
                        pricePerKg: 125,
                        scatteringCoefficient: 45,
                        absorptionCoefficient: 2.8,
                        undertone: "yellow",
                        massTintingStrength: 85,
                        hueAngle: 25, // degrees in CIELAB
                        chroma: 42,
                        shadeClassification: "light_red",
                        colorStrength: "medium",
                        properties: { strength: 85, lightfastness: 8, heatResistance: 1000 }
                    },
                    {
                        name: "Iron Oxide Red (Medium)",
                        chemFormula: "FeâOâ",
                        indianSuppliers: ["Lanxess India", "Toda Kogyo India"],
                        grades: ["PR101 Medium", "Bayferrox 130M"],
                        pricePerKg: 135,
                        scatteringCoefficient: 38,
                        absorptionCoefficient: 3.5,
                        undertone: "neutral",
                        massTintingStrength: 105,
                        hueAngle: 35,
                        chroma: 52,
                        shadeClassification: "medium_red",
                        colorStrength: "high",
                        properties: { strength: 105, lightfastness: 8, heatResistance: 1000 }
                    },
                    {
                        name: "Iron Oxide Red (Deep)",
                        chemFormula: "FeâOâ",
                        indianSuppliers: ["Lanxess India", "Cathay Pigments India"],
                        grades: ["PR101 Deep", "Bayferrox 318M"],
                        pricePerKg: 145,
                        scatteringCoefficient: 32,
                        absorptionCoefficient: 4.2,
                        undertone: "blue",
                        massTintingStrength: 125,
                        hueAngle: 45,
                        chroma: 65,
                        shadeClassification: "deep_red",
                        colorStrength: "very_high",
                        properties: { strength: 125, lightfastness: 8, heatResistance: 1000 }
                    },
                    {
                        name: "Quinacridone Red (Violet)",
                        chemFormula: "CââHââNâOâ",
                        indianSuppliers: ["Clariant India", "Sun Chemical India"],
                        grades: ["PR122", "Hostaperm Red P2B"],
                        pricePerKg: 980,
                        scatteringCoefficient: 25,
                        absorptionCoefficient: 8.5,
                        undertone: "blue",
                        massTintingStrength: 160,
                        hueAngle: 15,
                        chroma: 78,
                        shadeClassification: "violet_red",
                        colorStrength: "very_high",
                        properties: { strength: 160, lightfastness: 8, heatResistance: 200 }
                    },
                    {
                        name: "Quinacridone Red (Yellow)",
                        chemFormula: "CââHââNâOâ",
                        indianSuppliers: ["Clariant India", "DIC Corporation"],
                        grades: ["PR209", "Hostaperm Red P4B"],
                        pricePerKg: 1050,
                        scatteringCoefficient: 28,
                        absorptionCoefficient: 7.8,
                        undertone: "yellow",
                        massTintingStrength: 145,
                        hueAngle: 55,
                        chroma: 72,
                        shadeClassification: "yellow_red",
                        colorStrength: "very_high",
                        properties: { strength: 145, lightfastness: 8, heatResistance: 200 }
                    },
                    {
                        name: "Naphthol Red (Light)",
                        chemFormula: "CââHââClNâOâ",
                        indianSuppliers: ["Sudarshan Chemical", "Clariant India"],
                        grades: ["PR5", "Permanent Red F3RK"],
                        pricePerKg: 385,
                        scatteringCoefficient: 42,
                        absorptionCoefficient: 5.2,
                        undertone: "yellow",
                        massTintingStrength: 95,
                        hueAngle: 48,
                        chroma: 58,
                        shadeClassification: "orange_red",
                        colorStrength: "medium",
                        properties: { strength: 95, lightfastness: 6, heatResistance: 160 }
                    }
                ],
                blue: [
                    {
                        name: "Phthalo Blue (Green Shade)",
                        chemFormula: "CââHââCuNâ",
                        indianSuppliers: ["Sudarshan Chemical Industries", "Pidilite Industries"],
                        grades: ["PB15:3", "Hostaperm Blue B2G"],
                        pricePerKg: 320,
                        scatteringCoefficient: 18,
                        absorptionCoefficient: 12.5,
                        undertone: "green",
                        massTintingStrength: 180,
                        hueAngle: 285,
                        chroma: 85,
                        shadeClassification: "green_blue",
                        colorStrength: "very_high",
                        properties: { strength: 180, lightfastness: 8, heatResistance: 200 }
                    },
                    {
                        name: "Phthalo Blue (Red Shade)",
                        chemFormula: "CââHââCuNâ",
                        indianSuppliers: ["Sudarshan Chemical Industries", "Neelikon Food Colors"],
                        grades: ["PB15:1", "Hostaperm Blue B4G"],
                        pricePerKg: 340,
                        scatteringCoefficient: 20,
                        absorptionCoefficient: 11.8,
                        undertone: "red",
                        massTintingStrength: 170,
                        hueAngle: 275,
                        chroma: 82,
                        shadeClassification: "red_blue",
                        colorStrength: "very_high",
                        properties: { strength: 170, lightfastness: 8, heatResistance: 200 }
                    },
                    {
                        name: "Ultramarine Blue",
                        chemFormula: "NaâAlâSiâOââSâ",
                        indianSuppliers: ["Ferro Corporation India", "Kolorjet Chemicals"],
                        grades: ["PB29", "Ultramarine Blue 463"],
                        pricePerKg: 145,
                        scatteringCoefficient: 65,
                        absorptionCoefficient: 2.8,
                        undertone: "red",
                        massTintingStrength: 45,
                        hueAngle: 295,
                        chroma: 58,
                        shadeClassification: "violet_blue",
                        colorStrength: "medium",
                        properties: { strength: 45, lightfastness: 7, heatResistance: 300 }
                    }
                ],
                yellow: [
                    {
                        name: "Iron Oxide Yellow (Light)",
                        chemFormula: "FeO(OH)Â·HâO",
                        indianSuppliers: ["Lanxess India", "Cathay Industries"],
                        grades: ["PY42 Light", "Bayferrox 910"],
                        pricePerKg: 135,
                        scatteringCoefficient: 58,
                        absorptionCoefficient: 1.8,
                        undertone: "green",
                        massTintingStrength: 65,
                        hueAngle: 95,
                        chroma: 68,
                        shadeClassification: "green_yellow",
                        colorStrength: "medium",
                        properties: { strength: 65, lightfastness: 8, heatResistance: 250 }
                    },
                    {
                        name: "Iron Oxide Yellow (Medium)",
                        chemFormula: "FeO(OH)Â·HâO",
                        indianSuppliers: ["Lanxess India", "Toda Kogyo"],
                        grades: ["PY42 Medium", "Bayferrox 920"],
                        pricePerKg: 145,
                        scatteringCoefficient: 52,
                        absorptionCoefficient: 2.2,
                        undertone: "neutral",
                        massTintingStrength: 75,
                        hueAngle: 85,
                        chroma: 72,
                        shadeClassification: "medium_yellow",
                        colorStrength: "high",
                        properties: { strength: 75, lightfastness: 8, heatResistance: 250 }
                    },
                    {
                        name: "Hansa Yellow (Light)",
                        chemFormula: "CââHââClâNâOâ",
                        indianSuppliers: ["Sudarshan Chemical", "Clariant India"],
                        grades: ["PY74", "Permanent Yellow HR"],
                        pricePerKg: 285,
                        scatteringCoefficient: 45,
                        absorptionCoefficient: 3.5,
                        undertone: "green",
                        massTintingStrength: 90,
                        hueAngle: 105,
                        chroma: 88,
                        shadeClassification: "greenish_yellow",
                        colorStrength: "high",
                        properties: { strength: 90, lightfastness: 7, heatResistance: 180 }
                    }
                ],
                green: [
                    {
                        name: "Phthalo Green (Blue Shade)",
                        chemFormula: "CââHââCuNâClââ",
                        indianSuppliers: ["Sudarshan Chemical", "Clariant India"],
                        grades: ["PG7", "Hostaperm Green GNX"],
                        pricePerKg: 340,
                        scatteringCoefficient: 22,
                        absorptionCoefficient: 8.5,
                        undertone: "blue",
                        massTintingStrength: 140,
                        hueAngle: 165,
                        chroma: 78,
                        shadeClassification: "blue_green",
                        colorStrength: "very_high",
                        properties: { strength: 140, lightfastness: 8, heatResistance: 200 }
                    },
                    {
                        name: "Phthalo Green (Yellow Shade)",
                        chemFormula: "CââHââCuNâClââ",
                        indianSuppliers: ["Sudarshan Chemical", "Pidilite"],
                        grades: ["PG36", "Hostaperm Green G2G"],
                        pricePerKg: 360,
                        scatteringCoefficient: 25,
                        absorptionCoefficient: 7.8,
                        undertone: "yellow",
                        massTintingStrength: 125,
                        hueAngle: 145,
                        chroma: 82,
                        shadeClassification: "yellow_green",
                        colorStrength: "very_high",
                        properties: { strength: 125, lightfastness: 8, heatResistance: 200 }
                    }
                ],
                black: [
                    {
                        name: "Carbon Black (High Jetness)",
                        chemFormula: "C",
                        indianSuppliers: ["Phillips Carbon Black", "Himadri Speciality"],
                        grades: ["N110", "N220"],
                        pricePerKg: 85,
                        scatteringCoefficient: 8,
                        absorptionCoefficient: 45,
                        undertone: "blue",
                        massTintingStrength: 200,
                        properties: { jetness: 99, oilAbsorption: 120, density: 1.8 }
                    },
                    {
                        name: "Iron Oxide Black",
                        chemFormula: "FeâOâ",
                        indianSuppliers: ["Lanxess India", "Cathay Industries"],
                        grades: ["PBk11", "Bayferrox 318M"],
                        pricePerKg: 145,
                        scatteringCoefficient: 35,
                        absorptionCoefficient: 8.5,
                        undertone: "brown",
                        massTintingStrength: 85,
                        properties: { jetness: 85, oilAbsorption: 25, density: 5.18 }
                    }
                ]
            },

            // Enhanced binder database (keeping existing structure)
            binders: {
                emulsion_paint: [
                    {
                        name: "Acrylic Emulsion",
                        chemFormula: "(CâHâOâ)â",
                        indianSuppliers: ["Asian Paints", "Berger Paints", "Kansai Nerolac"],
                        grades: ["Pure Acrylic", "Styrene Acrylic", "Vinyl Acrylic"],
                        pricePerKg: 95,
                        solidsContent: 50,
                        properties: { Tg: 15, pH: 8.5, viscosity: 2000 }
                    }
                ],
                enamel_paint: [
                    {
                        name: "Alkyd Resin",
                        chemFormula: "CâHâ(COOH)â modified",
                        indianSuppliers: ["Allnex India", "Eternal Materials"],
                        grades: ["Short Oil", "Medium Oil", "Long Oil"],
                        pricePerKg: 125,
                        solidsContent: 70,
                        properties: { acidValue: 10, hydroxylValue: 50, viscosity: 5000 }
                    }
                ],
                automotive_paint: [
                    {
                        name: "Acrylic Polyol",
                        chemFormula: "(CâHâOâ)â-(CHâOH)â",
                        indianSuppliers: ["Allnex India", "Covestro India", "BASF India"],
                        grades: ["High Solids", "Low VOC"],
                        pricePerKg: 285,
                        solidsContent: 75,
                        properties: { hydroxylValue: 120, acidValue: 5, Tg: 45 }
                    }
                ]
            },

            // Enhanced additive database (keeping existing structure)
            additives: {
                thickeners: [
                    {
                        name: "Hydroxyethyl Cellulose",
                        chemFormula: "(CâHââOâ)â-(CâHâO)â",
                        indianSuppliers: ["Dow Chemical India", "Ashland India"],
                        grades: ["QP-300H", "Natrosol 250HR"],
                        pricePerKg: 285,
                        properties: { viscosity: "1500-2500 cP", pH: "6.5-8.5" }
                    }
                ],
                dispersants: [
                    {
                        name: "Sodium Polyacrylate",
                        chemFormula: "(CâHâNaOâ)â",
                        indianSuppliers: ["BYK India", "Elementis India"],
                        grades: ["Dispex AA4040", "Tamol 1124"],
                        pricePerKg: 185,
                        properties: { activeContent: 40, pH: 8 }
                    }
                ],
                wettingAgents: [
                    {
                        name: "Alkyl Polyglucoside",
                        chemFormula: "CââHââO(CâHââOâ)â",
                        indianSuppliers: ["BASF India", "Cognis India"],
                        grades: ["APG 0814", "Glucopon 215"],
                        pricePerKg: 165,
                        properties: { HLB: 13, surfaceTension: 28 }
                    }
                ],
                defoamers: [
                    {
                        name: "Mineral Oil Defoamer",
                        chemFormula: "Petroleum Hydrocarbons + SiOâ",
                        indianSuppliers: ["BYK India", "Munzing India"],
                        grades: ["Foamaster 111", "BYK-022"],
                        pricePerKg: 145,
                        properties: { activeContent: 100 }
                    }
                ],
                biocides: [
                    {
                        name: "Kathon IXP",
                        chemFormula: "CâHâClNâOâS",
                        indianSuppliers: ["Dow Chemical India", "Troy Corporation"],
                        grades: ["In-Can Preservative"],
                        pricePerKg: 1285,
                        properties: { activeContent: 1.5 }
                    }
                ],
                coalescents: [
                    {
                        name: "Dipropylene Glycol Monomethyl Ether",
                        chemFormula: "CâHââOâ",
                        indianSuppliers: ["Dow Chemical India", "LyondellBasell"],
                        grades: ["DPM", "Dowanol DPM"],
                        pricePerKg: 125,
                        properties: { boilingPoint: "190Â°C" }
                    }
                ]
            },

            // Enhanced solvent database
            solvents: {
                water_based: [
                    {
                        name: "Deionized Water",
                        chemFormula: "HâO",
                        indianSuppliers: ["Local Treatment Plants", "Ion Exchange India"],
                        grades: ["Type I", "Type II"],
                        pricePerKg: 2,
                        properties: { conductivity: "<1 Î¼S/cm", pH: "6.5-7.5" }
                    }
                ],
                solvent_based: [
                    {
                        name: "Xylene",
                        chemFormula: "CâHââ",
                        indianSuppliers: ["Indian Oil Corp", "Reliance Industries"],
                        grades: ["Commercial Grade", "Pure Grade"],
                        pricePerKg: 65,
                        properties: { boilingPoint: "138-144Â°C", density: 0.87 }
                    },
                    {
                        name: "Butyl Acetate",
                        chemFormula: "CâHââOâ",
                        indianSuppliers: ["Celanese India", "Eastman Chemical"],
                        grades: ["99.5% Pure", "Technical Grade"],
                        pricePerKg: 85,
                        properties: { boilingPoint: "126Â°C" }
                    }
                ]
            },

            // Enhanced extender database
            extenders: [
                {
                    name: "Calcium Carbonate (Precipitated)",
                    chemFormula: "CaCOâ",
                    indianSuppliers: ["20 Microns Ltd", "Omya India"],
                    grades: ["Coated PCC", "Uncoated PCC"],
                    pricePerKg: 22,
                    properties: { density: 2.71, whiteness: 95, pH: 9.5 }
                },
                {
                    name: "Kaolin Clay (Calcined)",
                    chemFormula: "AlâSiâOâ(OH)â",
                    indianSuppliers: ["Imerys India", "Ashapura Minechem"],
                    grades: ["Ansilex 93", "Polestar 200R"],
                    pricePerKg: 45,
                    properties: { density: 2.6, brightness: 90 }
                },
                {
                    name: "Talc",
                    chemFormula: "MgâSiâOââ(OH)â",
                    indianSuppliers: ["Luzenac India", "Jai Group"],
                    grades: ["Cosmetic Grade", "Industrial Grade"],
                    pricePerKg: 28,
                    properties: { density: 2.78, whiteness: 92 }
                }
            ]
        };

        // Advanced Color Science Engine
        class AdvancedColorScience {
            constructor() {
                this.illuminant = { x: 95.047, y: 100.000, z: 108.883 }; // D65
            }

            // Convert RGB to LAB color space
            rgbToLab(r, g, b) {
                // First convert RGB to XYZ
                let rNorm = r / 255.0;
                let gNorm = g / 255.0;
                let bNorm = b / 255.0;

                // Apply gamma correction
                rNorm = rNorm > 0.04045 ? Math.pow((rNorm + 0.055) / 1.055, 2.4) : rNorm / 12.92;
                gNorm = gNorm > 0.04045 ? Math.pow((gNorm + 0.055) / 1.055, 2.4) : gNorm / 12.92;
                bNorm = bNorm > 0.04045 ? Math.pow((bNorm + 0.055) / 1.055, 2.4) : bNorm / 12.92;

                // Convert to XYZ using sRGB matrix
                const x = (rNorm * 0.4124564 + gNorm * 0.3575761 + bNorm * 0.1804375) * 100;
                const y = (rNorm * 0.2126729 + gNorm * 0.7151522 + bNorm * 0.0721750) * 100;
                const z = (rNorm * 0.0193339 + gNorm * 0.1191920 + bNorm * 0.9503041) * 100;

                // Convert XYZ to LAB
                const xn = x / this.illuminant.x;
                const yn = y / this.illuminant.y;
                const zn = z / this.illuminant.z;

                const fx = xn > 0.008856 ? Math.pow(xn, 1/3) : (7.787 * xn + 16/116);
                const fy = yn > 0.008856 ? Math.pow(yn, 1/3) : (7.787 * yn + 16/116);
                const fz = zn > 0.008856 ? Math.pow(zn, 1/3) : (7.787 * zn + 16/116);

                const L = 116 * fy - 16;
                const a = 500 * (fx - fy);
                const b_lab = 200 * (fy - fz);

                return { L: Math.round(L), a: Math.round(a), b: Math.round(b_lab) };
            }

            // Convert RGB to HSL
            rgbToHsl(r, g, b) {
                r /= 255;
                g /= 255;
                b /= 255;

                const max = Math.max(r, g, b);
                const min = Math.min(r, g, b);
                let h, s, l;

                l = (max + min) / 2;

                if (max === min) {
                    h = s = 0; // achromatic
                } else {
                    const d = max - min;
                    s = l > 0.5 ? d / (2 - max - min) : d / (max + min);

                    switch (max) {
                        case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                        case g: h = (b - r) / d + 2; break;
                        case b: h = (r - g) / d + 4; break;
                    }
                    h /= 6;
                }

                return {
                    h: Math.round(h * 360),
                    s: Math.round(s * 100),
                    l: Math.round(l * 100)
                };
            }

            // Calculate chroma from LAB values
            calculateChroma(a, b) {
                return Math.sqrt(a * a + b * b);
            }

            // Determine precise color classification
            getDetailedColorClassification(r, g, b) {
                const lab = this.rgbToLab(r, g, b);
                const hsl = this.rgbToHsl(r, g, b);
                const chroma = this.calculateChroma(lab.a, lab.b);
                
                const lightness = lab.L;
                const saturation = hsl.s;
                const hue = hsl.h;

                // Determine base color family
                let baseColor, shadeClassification, colorStrength;

                if (chroma < 10) {
                    baseColor = 'neutral';
                    shadeClassification = lightness > 70 ? 'light_gray' : lightness > 30 ? 'medium_gray' : 'dark_gray';
                } else if (hue >= 345 || hue < 15) {
                    baseColor = 'red';
                    if (lightness > 60) shadeClassification = 'light_red';
                    else if (lightness > 35) shadeClassification = 'medium_red';
                    else shadeClassification = 'deep_red';
                } else if (hue >= 15 && hue < 45) {
                    baseColor = 'red';
                    shadeClassification = 'orange_red';
                } else if (hue >= 45 && hue < 75) {
                    baseColor = 'yellow';
                    shadeClassification = 'orange_yellow';
                } else if (hue >= 75 && hue < 105) {
                    baseColor = 'yellow';
                    if (lightness > 70) shadeClassification = 'light_yellow';
                    else shadeClassification = 'medium_yellow';
                } else if (hue >= 105 && hue < 135) {
                    baseColor = 'yellow';
                    shadeClassification = 'greenish_yellow';
                } else if (hue >= 135 && hue < 165) {
                    baseColor = 'green';
                    shadeClassification = 'yellow_green';
                } else if (hue >= 165 && hue < 195) {
                    baseColor = 'green';
                    if (lightness > 50) shadeClassification = 'medium_green';
                    else shadeClassification = 'deep_green';
                } else if (hue >= 195 && hue < 225) {
                    baseColor = 'green';
                    shadeClassification = 'blue_green';
                } else if (hue >= 225 && hue < 255) {
                    baseColor = 'blue';
                    shadeClassification = 'green_blue';
                } else if (hue >= 255 && hue < 285) {
                    baseColor = 'blue';
                    if (lightness > 50) shadeClassification = 'medium_blue';
                    else shadeClassification = 'deep_blue';
                } else if (hue >= 285 && hue < 315) {
                    baseColor = 'blue';
                    shadeClassification = 'violet_blue';
                } else {
                    baseColor = 'red';
                    shadeClassification = 'violet_red';
                }

                // Determine color strength
                if (chroma > 70) colorStrength = 'very_high';
                else if (chroma > 50) colorStrength = 'high';
                else if (chroma > 30) colorStrength = 'medium';
                else colorStrength = 'low';

                return {
                    baseColor,
                    shadeClassification,
                    colorStrength,
                    lab,
                    hsl,
                    chroma: Math.round(chroma),
                    lightness: Math.round(lightness),
                    saturation: Math.round(saturation),
                    hue: Math.round(hue)
                };
            }

            // Calculate pigment requirements using Kubelka-Munk theory
            calculatePigmentLoad(targetColor, application, qualityGrade) {
                const analysis = this.getDetailedColorClassification(targetColor.r, targetColor.g, targetColor.b);
                
                // Base pigment load depends on application
                const baseLoads = {
                    emulsion_paint: 15,
                    enamel_paint: 18,
                    automotive_paint: 22,
                    textile_printing: 25,
                    plastic_masterbatch: 40,
                    printing_ink: 30,
                    cosmetic_color: 12,
                    ceramic_glaze: 14,
                    industrial_coating: 20,
                    powder_coating: 16
                };

                let basePigmentLoad = baseLoads[application] || 15;

                // Adjust for color strength and chroma
                const chromaFactor = analysis.chroma / 100;
                const lightnessFactor = analysis.lightness / 100;
                
                // Higher chroma requires more pigment
                basePigmentLoad *= (1 + chromaFactor * 0.5);
                
                // Darker colors need more pigment
                if (analysis.lightness < 50) {
                    basePigmentLoad *= (1 + (50 - analysis.lightness) / 100);
                }

                // Quality grade adjustments
                const qualityFactors = {
                    economy: 0.85,
                    standard: 1.0,
                    premium: 1.15,
                    super_premium: 1.3
                };

                basePigmentLoad *= qualityFactors[qualityGrade] || 1.0;

                return Math.round(basePigmentLoad * 10) / 10; // Round to 1 decimal
            }

            // Select optimal pigments based on scientific analysis
            selectOptimalPigments(colorAnalysis, application, qualityGrade) {
                const { baseColor, shadeClassification, colorStrength } = colorAnalysis;
                let selectedPigments = [];

                const pigmentDb = scientificColorDatabase.pigments;

                // Select pigments based on precise shade classification
                switch (baseColor) {
                    case 'red':
                        if (shadeClassification === 'light_red') {
                            selectedPigments.push(pigmentDb.red.find(p => p.shadeClassification === 'light_red'));
                        } else if (shadeClassification === 'medium_red') {
                            selectedPigments.push(pigmentDb.red.find(p => p.shadeClassification === 'medium_red'));
                        } else if (shadeClassification === 'deep_red') {
                            selectedPigments.push(pigmentDb.red.find(p => p.shadeClassification === 'deep_red'));
                        } else if (shadeClassification === 'orange_red') {
                            selectedPigments.push(pigmentDb.red.find(p => p.shadeClassification === 'orange_red'));
                        } else if (shadeClassification === 'violet_red') {
                            if (qualityGrade === 'premium' || qualityGrade === 'super_premium') {
                                selectedPigments.push(pigmentDb.red.find(p => p.shadeClassification === 'violet_red'));
                            } else {
                                selectedPigments.push(pigmentDb.red.find(p => p.shadeClassification === 'deep_red'));
                            }
                        } else if (shadeClassification === 'yellow_red') {
                            if (qualityGrade === 'premium' || qualityGrade === 'super_premium') {
                                selectedPigments.push(pigmentDb.red.find(p => p.shadeClassification === 'yellow_red'));
                            } else {
                                selectedPigments.push(pigmentDb.red.find(p => p.shadeClassification === 'light_red'));
                            }
                        }
                        break;

                    case 'blue':
                        if (shadeClassification === 'green_blue') {
                            selectedPigments.push(pigmentDb.blue.find(p => p.shadeClassification === 'green_blue'));
                        } else if (shadeClassification === 'red_blue') {
                            selectedPigments.push(pigmentDb.blue.find(p => p.shadeClassification === 'red_blue'));
                        } else if (shadeClassification === 'violet_blue') {
                            selectedPigments.push(pigmentDb.blue.find(p => p.shadeClassification === 'violet_blue'));
                        } else {
                            // Default to phthalo blue green shade for general blue
                            selectedPigments.push(pigmentDb.blue.find(p => p.shadeClassification === 'green_blue'));
                        }
                        break;

                    case 'yellow':
                        if (shadeClassification === 'green_yellow' || shadeClassification === 'greenish_yellow') {
                            selectedPigments.push(pigmentDb.yellow.find(p => p.shadeClassification === 'green_yellow'));
                        } else if (shadeClassification === 'medium_yellow') {
                            selectedPigments.push(pigmentDb.yellow.find(p => p.shadeClassification === 'medium_yellow'));
                        } else {
                            // For organic applications, prefer Hansa yellow
                            if (application === 'printing_ink' || application === 'plastic_masterbatch') {
                                selectedPigments.push(pigmentDb.yellow.find(p => p.shadeClassification === 'greenish_yellow'));
                            } else {
                                selectedPigments.push(pigmentDb.yellow.find(p => p.shadeClassification === 'medium_yellow'));
                            }
                        }
                        break;

                    case 'green':
                        if (shadeClassification === 'blue_green') {
                            selectedPigments.push(pigmentDb.green.find(p => p.shadeClassification === 'blue_green'));
                        } else if (shadeClassification === 'yellow_green') {
                            selectedPigments.push(pigmentDb.green.find(p => p.shadeClassification === 'yellow_green'));
                        } else {
                            selectedPigments.push(pigmentDb.green.find(p => p.shadeClassification === 'blue_green'));
                        }
                        break;

                    case 'neutral':
                        // Add appropriate black pigment
                        if (application === 'printing_ink' || application === 'plastic_masterbatch') {
                            selectedPigments.push(pigmentDb.black.find(p => p.name.includes('Carbon Black')));
                        } else {
                            selectedPigments.push(pigmentDb.black.find(p => p.name.includes('Iron Oxide Black')));
                        }
                        break;
                }

                // Add white pigment for lighter shades
                if (colorAnalysis.lightness > 60) {
                    selectedPigments.push(pigmentDb.white[0]); // Titanium dioxide
                }

                // Filter out undefined pigments and ensure we have valid selections
                selectedPigments = selectedPigments.filter(p => p !== undefined);

                return selectedPigments;
            }
        }

        // Manufacturing processes with shade-specific adjustments
        const advancedManufacturingProcesses = {
            emulsion_paint: {
                light_shades: [
                    "1. Pre-mix: Combine water, dispersant, and thickener (300 RPM, 3 min)",
                    "2. White pigment addition: Add TiOâ slowly to avoid agglomeration (200 RPM, 8 min)",
                    "3. Color pigment addition: Add tinting pigments gradually (250 RPM, 5 min)",
                    "4. Grinding: Sand mill to achieve <20 Î¼m (30-45 min) - gentle grinding for light shades",
                    "5. Let-down: Add binder emulsion at controlled rate (150 RPM, 12 min)",
                    "6. Coalescent addition: Add slowly to prevent foaming (100 RPM, 5 min)",
                    "7. Additive incorporation: pH adjusters, biocides, defoamers (80 RPM, 8 min)",
                    "8. Extender addition: Add calcium carbonate carefully (120 RPM, 15 min)",
                    "9. Final adjustment: pH 8.2-8.6, viscosity 90-95 KU",
                    "10. Quality check: Color matching under D65, fineness <25 Î¼m"
                ],
                medium_shades: [
                    "1. Pre-mix: Water, dispersant, wetting agent (400 RPM, 4 min)",
                    "2. Pigment paste preparation: High-speed mixing of color pigments (1000 RPM, 15 min)",
                    "3. Grinding: Intensive sand mill grinding to <18 Î¼m (45-60 min)",
                    "4. White pigment addition: TiOâ for opacity adjustment (300 RPM, 6 min)",
                    "5. Let-down: Binder addition with temperature control <30Â°C (200 RPM, 15 min)",
                    "6. Rheology adjustment: Thickener addition for proper flow (100 RPM, 10 min)",
                    "7. Additive package: All auxiliaries in correct sequence (150 RPM, 12 min)",
                    "8. Extender incorporation: PCC and kaolin addition (180 RPM, 18 min)",
                    "9. Final adjustment: pH 8.3-8.7, viscosity 88-92 KU",
                    "10. Color verification: Spectrophotometric analysis, ÎE <1.0"
                ],
                deep_shades: [
                    "1. Pre-mix: Water, high-efficiency dispersant (500 RPM, 5 min)",
                    "2. Pigment pre-wetting: Intensive wetting of high-loading pigments (800 RPM, 10 min)",
                    "3. Multiple-stage grinding: Progressive size reduction to <15 Î¼m (60-90 min)",
                    "4. Color strength verification: Check against standard every 15 min",
                    "5. Binder let-down: Gradual addition to prevent shock (250 RPM, 20 min)",
                    "6. Temperature control: Maintain <28Â°C during let-down",
                    "7. Rheology optimization: Associative thickener for deep shade stability",
                    "8. Minimal extender addition: Only necessary functional fillers",
                    "9. Final adjustment: pH 8.4-8.8, viscosity 85-90 KU",
                    "10. Color matching: Multi-angle spectrophotometry, metamerism check"
                ]
            },
            automotive_paint: {
                metallic_shades: [
                    "1. Solvent blend: Xylene/butyl acetate 65:35 with anti-settling agent",
                    "2. Aluminum paste preparation: Gentle mixing to preserve leafing (200 RPM, 5 min)",
                    "3. Color pigment grinding: Three-roll mill to <10 Î¼m (multiple passes)",
                    "4. Resin solution: Acrylic polyol in aromatic solvent (300 RPM, 25 min)",
                    "5. Pigment let-down: Combine color paste with resin solution",
                    "6. Metallic addition: Add aluminum paste last to prevent damage",
                    "7. Rheology adjustment: Specific for spray application",
                    "8. Hardener preparation: Isocyanate crosslinker just before use",
                    "9. Viscosity: 16-20 sec Ford Cup #4 for optimal spray",
                    "10. Quality check: Flip-flop effect, color travel, DOI measurement"
                ]
            }
        };

        // Initialize the advanced color science engine
        const colorScience = new AdvancedColorScience();

        // Enhanced formulation generator with scientific calculations
        function generateScientificFormulation(hex, application, batchSize, qualityGrade) {
            const btnText = document.getElementById('formulateText');
            const spinner = document.getElementById('formulateSpinner');
            btnText.textContent = "Calculating...";
            spinner.classList.remove('hidden');
            
            setTimeout(() => {
                const r = parseInt(hex.slice(1, 3), 16);
                const g = parseInt(hex.slice(3, 5), 16);
                const b = parseInt(hex.slice(5, 7), 16);
                
                // Perform detailed color analysis
                const colorAnalysis = colorScience.getDetailedColorClassification(r, g, b);
                const pigmentLoad = colorScience.calculatePigmentLoad({r, g, b}, application, qualityGrade);
                
                // Display color analysis
                displayColorAnalysis(colorAnalysis, hex);
                
                let completeFormula = [];
                
                // Select optimal pigments based on scientific analysis
                const selectedPigments = colorScience.selectOptimalPigments(colorAnalysis, application, qualityGrade);
                
                // Calculate precise pigment amounts using scientific methods
                addScientificPigments(completeFormula, selectedPigments, colorAnalysis, pigmentLoad, qualityGrade);
                
                // Add other components based on application
                const formulationBase = getFormulationBase(application);
                addBindersToFormula(completeFormula, application, formulationBase.binder, qualityGrade);
                addSolventsToFormula(completeFormula, application, formulationBase.solvent);
                addAdditivesToFormula(completeFormula, application, qualityGrade);
                addExtendersToFormula(completeFormula, application, formulationBase.extender, qualityGrade);
                
                // Scale formula to batch size
                const totalWeight = completeFormula.reduce((sum, comp) => sum + comp.grams, 0);
                const scaleFactor = (batchSize * 1000) / totalWeight;
                completeFormula = completeFormula.map(comp => ({
                    ...comp,
                    grams: Math.round(comp.grams * scaleFactor),
                    percentage: ((comp.grams * scaleFactor) / (batchSize * 1000) * 100).toFixed(2)
                }));
                
                // Display complete formulation
                displayCompleteFormulation(completeFormula, batchSize);
                
                // Display shade-specific manufacturing process
                displayShadeSpecificProcess(application, colorAnalysis.shadeClassification);
                
                // Display quality control parameters
                generateQualityControl(hex, application);
                
                // Update additional metrics
                updateScientificMetrics(colorAnalysis, pigmentLoad, completeFormula);
                
                // Update console
                addConsoleMessage(`Scientific formulation calculated for ${colorAnalysis.shadeClassification} (${colorAnalysis.baseColor})`);
                addConsoleMessage(`Pigment load: ${pigmentLoad}% | Color strength: ${colorAnalysis.colorStrength} | Chroma: ${colorAnalysis.chroma}`);
                addConsoleMessage(`Formula optimized for ${application} application at ${qualityGrade} grade`);
                
                // Reset button state
                btnText.textContent = "Calculate";
                spinner.classList.add('hidden');
            }, 2500); // Slightly longer for scientific calculations
        }

        function displayColorAnalysis(analysis, hex) {
            const analysisContainer = document.getElementById('colorAnalysis');
            
            analysisContainer.innerHTML = `
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                    <div>
                        <strong>Base Color:</strong> ${analysis.baseColor.charAt(0).toUpperCase() + analysis.baseColor.slice(1)}
                    </div>
                    <div>
                        <strong>Shade Type:</strong> ${analysis.shadeClassification.replace(/_/g, ' ').toUpperCase()}
                    </div>
                    <div>
                        <strong>Color Strength:</strong> ${analysis.colorStrength.replace(/_/g, ' ').toUpperCase()}
                    </div>
                    <div>
                        <strong>Undertone:</strong> Calculated scientifically
                    </div>
                </div>
                <div class="mt-3 text-xs text-blue-700">
                    <strong>Scientific Analysis:</strong> This ${analysis.shadeClassification.replace(/_/g, ' ')} requires specific pigment selection 
                    based on L*a*b* values (L:${analysis.lab.L}, a:${analysis.lab.a}, b:${analysis.lab.b}) and chroma value of ${analysis.chroma}.
                    Formulation optimized using Kubelka-Munk color matching theory.
                </div>
            `;

            // Update the color value displays
            document.getElementById('hslValue').textContent = `${analysis.hsl.h}Â°, ${analysis.hsl.s}%, ${analysis.hsl.l}%`;
            document.getElementById('labValue').textContent = `L:${analysis.lab.L} a:${analysis.lab.a} b:${analysis.lab.b}`;
            document.getElementById('colorStrength').textContent = `${analysis.colorStrength.replace(/_/g, ' ')} (${analysis.chroma}%)`;
            document.getElementById('chromaValue').textContent = analysis.chroma.toString();
        }

        function addScientificPigments(formula, selectedPigments, colorAnalysis, pigmentLoad, qualityGrade) {
            const totalPigmentWeight = (pigmentLoad / 100) * 1000; // Base 1kg
            let allocatedWeight = 0;

            selectedPigments.forEach((pigment, index) => {
                let pigmentWeight = 0;
                
                if (pigment.name.includes('Titanium Dioxide') || pigment.name.includes('Zinc Oxide')) {
                    // White pigments - amount based on lightness
                    pigmentWeight = totalPigmentWeight * (colorAnalysis.lightness / 100) * 0.6;
                } else if (pigment.name.includes('Carbon Black') || pigment.name.includes('Iron Oxide Black')) {
                    // Black pigments - amount based on darkness
                    pigmentWeight = totalPigmentWeight * ((100 - colorAnalysis.lightness) / 100) * 0.3;
                } else {
                    // Color pigments - calculate based on color strength and chroma
                    const strengthFactor = colorAnalysis.chroma / 100;
                    const qualityFactor = qualityGrade === 'super_premium' ? 1.2 : 
                                        qualityGrade === 'premium' ? 1.1 : 
                                        qualityGrade === 'standard' ? 1.0 : 0.9;
                    
                    // Calculate based on pigment's mass tinting strength
                    const mts = pigment.massTintingStrength || 100;
                    const baseAmount = (totalPigmentWeight * strengthFactor * 0.7) / (mts / 100);
                    pigmentWeight = baseAmount * qualityFactor;
                }

                // Ensure we don't exceed total pigment weight
                if (allocatedWeight + pigmentWeight > totalPigmentWeight) {
                    pigmentWeight = totalPigmentWeight - allocatedWeight;
                }

                if (pigmentWeight > 0) {
                    formula.push({
                        category: 'Pigment',
                        name: pigment.name,
                        chemFormula: pigment.chemFormula,
                        supplier: pigment.indianSuppliers[0],
                        grade: pigment.grades[0],
                        grams: Math.round(pigmentWeight * 10) / 10,
                        function: index === 0 ? 'Primary colorant' : 
                                 pigment.name.includes('Titanium') ? 'Opacity provider' :
                                 pigment.name.includes('Black') ? 'Shade deepener' : 'Color modifier',
                        pricePerKg: pigment.pricePerKg,
                        scientificData: {
                            massTintingStrength: pigment.massTintingStrength,
                            undertone: pigment.undertone,
                            shadeClassification: pigment.shadeClassification
                        }
                    });
                    
                    allocatedWeight += pigmentWeight;
                }
            });
        }

        function displayShadeSpecificProcess(application, shadeClassification) {
            const processContainer = document.getElementById('manufacturingProcess');
            
            // Determine shade category
            let shadeCategory = 'medium_shades'; // default
            if (shadeClassification.includes('light') || shadeClassification.includes('pale')) {
                shadeCategory = 'light_shades';
            } else if (shadeClassification.includes('deep') || shadeClassification.includes('dark')) {
                shadeCategory = 'deep_shades';
            }

            let processes = [];
            if (advancedManufacturingProcesses[application] && 
                advancedManufacturingProcesses[application][shadeCategory]) {
                processes = advancedManufacturingProcesses[application][shadeCategory];
            } else {
                // Fall back to basic process
                processes = [
                    "1. Pre-mix: Combine liquid components with dispersant (300 RPM, 5 min)",
                    "2. Pigment addition: Add pigments based on scientific calculations",
                    "3. Grinding: Achieve particle size based on shade requirements",
                    "4. Let-down: Add binder system gradually",
                    "5. Additive incorporation: pH adjusters, rheology modifiers",
                    "6. Quality control: Color matching and consistency check",
                    "7. Final adjustment: Viscosity and pH optimization",
                    "8. Packaging: Fill in appropriate containers"
                ];
            }
            
            processContainer.innerHTML = processes.map((step, index) => `
                <div class="process-step">
                    <span class="font-semibold text-orange-600">${step}</span>
                </div>
            `).join('');
        }

        function updateScientificMetrics(colorAnalysis, pigmentLoad, formula) {
            document.getElementById('pigmentLoad').textContent = `${pigmentLoad}%`;
            document.getElementById('colorAccuracy').textContent = `ÎE < ${colorAnalysis.colorStrength === 'very_high' ? '0.5' : '1.0'}`;
            document.getElementById('shadeClass').textContent = colorAnalysis.shadeClassification.replace(/_/g, ' ').toUpperCase();
        }

        // Enhanced functions (keeping existing structure but with scientific improvements)
        function getFormulationBase(application) {
            const bases = {
                emulsion_paint: { pigment: 15, binder: 25, solvent: 45, extender: 12, additive: 3 },
                enamel_paint: { pigment: 18, binder: 35, solvent: 35, extender: 10, additive: 2 },
                automotive_paint: { pigment: 20, binder: 45, solvent: 25, extender: 8, additive: 2 },
                textile_printing: { pigment: 25, binder: 15, solvent: 45, extender: 5, additive: 10 },
                plastic_masterbatch: { pigment: 40, binder: 55, solvent: 0, extender: 3, additive: 2 },
                printing_ink: { pigment: 30, binder: 35, solvent: 25, extender: 8, additive: 2 },
                cosmetic_color: { pigment: 10, binder: 20, solvent: 60, extender: 5, additive: 5 },
                ceramic_glaze: { pigment: 12, binder: 25, solvent: 35, extender: 25, additive: 3 },
                industrial_coating: { pigment: 22, binder: 40, solvent: 28, extender: 8, additive: 2 },
                powder_coating: { pigment: 15, binder: 75, solvent: 0, extender: 8, additive: 2 }
            };
            return bases[application] || bases.emulsion_paint;
        }

        function addBindersToFormula(formula, application, binderPercentage, qualityGrade) {
            const targetWeight = (binderPercentage / 100) * 1000;
            
            if (scientificColorDatabase.binders[application]) {
                const binders = scientificColorDatabase.binders[application];
                const primaryBinder = binders[0];
                
                formula.push({
                    category: 'Binder',
                    name: primaryBinder.name,
                    chemFormula: primaryBinder.chemFormula,
                    supplier: primaryBinder.indianSuppliers[0],
                    grade: primaryBinder.grades[0],
                    grams: targetWeight,
                    function: 'Film forming polymer',
                    pricePerKg: primaryBinder.pricePerKg
                });
            }
        }

        function addSolventsToFormula(formula, application, solventPercentage) {
            const targetWeight = (solventPercentage / 100) * 1000;
            
            if (application.includes('emulsion') || application.includes('textile')) {
                const water = scientificColorDatabase.solvents.water_based[0];
                formula.push({
                    category: 'Solvent',
                    name: water.name,
                    chemFormula: water.chemFormula,
                    supplier: water.indianSuppliers[0],
                    grade: water.grades[0],
                    grams: targetWeight,
                    function: 'Carrier medium',
                    pricePerKg: water.pricePerKg
                });
            } else {
                const solvents = scientificColorDatabase.solvents.solvent_based;
                formula.push({
                    category: 'Solvent',
                    name: solvents[0].name,
                    chemFormula: solvents[0].chemFormula,
                    supplier: solvents[0].indianSuppliers[0],
                    grade: solvents[0].grades[0],
                    grams: targetWeight * 0.6,
                    function: 'Primary solvent',
                    pricePerKg: solvents[0].pricePerKg
                });
                
                formula.push({
                    category: 'Solvent',
                    name: solvents[1].name,
                    chemFormula: solvents[1].chemFormula,
                    supplier: solvents[1].indianSuppliers[0],
                    grade: solvents[1].grades[0],
                    grams: targetWeight * 0.4,
                    function: 'Secondary solvent',
                    pricePerKg: solvents[1].pricePerKg
                });
            }
        }

        function addAdditivesToFormula(formula, application, qualityGrade) {
            const additives = scientificColorDatabase.additives;
            
            // Thickener
            const thickener = additives.thickeners[0];
            formula.push({
                category: 'Additive',
                name: thickener.name,
                chemFormula: thickener.chemFormula,
                supplier: thickener.indianSuppliers[0],
                grade: thickener.grades[0],
                grams: application.includes('emulsion') ? 8 : 3,
                function: 'Viscosity control',
                pricePerKg: thickener.pricePerKg
            });
            
            // Dispersant
            const dispersant = additives.dispersants[0];
            formula.push({
                category: 'Additive',
                name: dispersant.name,
                chemFormula: dispersant.chemFormula,
                supplier: dispersant.indianSuppliers[0],
                grade: dispersant.grades[0],
                grams: 5,
                function: 'Pigment dispersion',
                pricePerKg: dispersant.pricePerKg
            });
            
            // Wetting agent
            const wettingAgent = additives.wettingAgents[0];
            formula.push({
                category: 'Additive',
                name: wettingAgent.name,
                chemFormula: wettingAgent.chemFormula,
                supplier: wettingAgent.indianSuppliers[0],
                grade: wettingAgent.grades[0],
                grams: 2,
                function: 'Surface tension reduction',
                pricePerKg: wettingAgent.pricePerKg
            });
            
            // Biocide for water-based systems
            if (application.includes('emulsion') || application.includes('textile')) {
                const biocide = additives.biocides[0];
                formula.push({
                    category: 'Additive',
                    name: biocide.name,
                    chemFormula: biocide.chemFormula,
                    supplier: biocide.indianSuppliers[0],
                    grade: biocide.grades[0],
                    grams: 1,
                    function: 'Preservation',
                    pricePerKg: biocide.pricePerKg
                });
            }
            
            // Coalescent for emulsion paints
            if (application.includes('emulsion')) {
                const coalescent = additives.coalescents[0];
                formula.push({
                    category: 'Additive',
                    name: coalescent.name,
                    chemFormula: coalescent.chemFormula,
                    supplier: coalescent.indianSuppliers[0],
                    grade: coalescent.grades[0],
                    grams: 12,
                    function: 'Film formation aid',
                    pricePerKg: coalescent.pricePerKg
                });
            }
        }

        function addExtendersToFormula(formula, application, extenderPercentage, qualityGrade) {
            const targetWeight = (extenderPercentage / 100) * 1000;
            const extenders = scientificColorDatabase.extenders;
            
            if (application !== 'cosmetic_color' && targetWeight > 0) {
                const caco3 = extenders[0];
                formula.push({
                    category: 'Extender',
                    name: caco3.name,
                    chemFormula: caco3.chemFormula,
                    supplier: caco3.indianSuppliers[0],
                    grade: caco3.grades[0],
                    grams: targetWeight * 0.7,
                    function: 'Volume extender',
                    pricePerKg: caco3.pricePerKg
                });
                
                const secondaryExtender = qualityGrade === 'economy' ? extenders[0] : extenders[1];
                formula.push({
                    category: 'Extender',
                    name: secondaryExtender.name,
                    chemFormula: secondaryExtender.chemFormula,
                    supplier: secondaryExtender.indianSuppliers[0],
                    grade: secondaryExtender.grades[0],
                    grams: targetWeight * 0.3,
                    function: 'Performance enhancer',
                    pricePerKg: secondaryExtender.pricePerKg
                });
            }
        }

        // Enhanced display functions (keeping existing structure)
        function displayCompleteFormulation(formula, batchSize) {
            const formulaContent = document.getElementById('formulaContent');
            const totalWeight = formula.reduce((sum, comp) => sum + comp.grams, 0);
            
            const groupedFormula = {};
            formula.forEach(comp => {
                if (!groupedFormula[comp.category]) {
                    groupedFormula[comp.category] = [];
                }
                groupedFormula[comp.category].push(comp);
            });
            
            let htmlContent = '';
            const categoryOrder = ['Pigment', 'Binder', 'Solvent', 'Additive', 'Extender'];
            
            categoryOrder.forEach(category => {
                if (groupedFormula[category]) {
                    htmlContent += `
                        <tr class="component-category">
                            <td colspan="8">${category.toUpperCase()} COMPONENTS</td>
                        </tr>
                    `;
                    
                    groupedFormula[category].forEach(component => {
                        const costPerComponent = ((component.grams/1000) * component.pricePerKg).toFixed(2);
                        htmlContent += `
                            <tr class="hover:bg-gray-50">
                                <td class="font-medium text-gray-900">${component.name}</td>
                                <td><span class="chemical-formula">${component.chemFormula}</span></td>
                                <td class="supplier-text">${component.supplier}</td>
                                <td class="weight-display">${component.grams}g</td>
                                <td><span class="percentage-display">${component.percentage}%</span></td>
                                <td class="function-text">${component.function}</td>
                                <td><span class="grade-text">${component.grade}</span></td>
                                <td class="font-mono text-sm">â¹${costPerComponent}</td>
                            </tr>
                        `;
                    });
                }
            });
            
            formulaContent.innerHTML = htmlContent;
            
            document.getElementById('totalWeight').textContent = `${(totalWeight/1000).toFixed(2)}kg`;
            
            const solidComponents = formula.filter(comp => 
                comp.category !== 'Solvent' || comp.name !== 'Deionized Water'
            );
            const solidWeight = solidComponents.reduce((sum, comp) => sum + comp.grams, 0);
            const solidContent = ((solidWeight / totalWeight) * 100).toFixed(1);
            document.getElementById('solidContent').textContent = `${solidContent}%`;
            
            displayFormulaSummary(groupedFormula, totalWeight);
        }

        function displayFormulaSummary(groupedFormula, totalWeight) {
            const summaryContainer = document.getElementById('formulaSummary');
            
            const categoryTotals = {};
            Object.keys(groupedFormula).forEach(category => {
                categoryTotals[category] = groupedFormula[category].reduce((sum, comp) => sum + comp.grams, 0);
            });
            
            summaryContainer.innerHTML = Object.keys(categoryTotals).map(category => `
                <div class="bg-gradient-to-br from-blue-50 to-indigo-50 p-3 rounded-lg text-center border border-blue-200">
                    <div class="text-xs text-blue-600 uppercase font-semibold">${category}</div>
                    <div class="font-bold text-lg text-blue-800">${((categoryTotals[category] / totalWeight) * 100).toFixed(1)}%</div>
                    <div class="text-xs text-blue-500">${categoryTotals[category]}g</div>
                </div>
            `).join('');
        }

        function generateQualityControl(color, application) {
            const qcContainer = document.getElementById('qualityControl');
            const parameters = {
                emulsion_paint: [
                    { name: "Fineness", value: "â¤25 Î¼m", unit: "Hegman gauge" },
                    { name: "Viscosity", value: "85-95 KU", unit: "Stormer" },
                    { name: "Color Accuracy", value: "ÎE <1.0", unit: "CIE Lab" },
                    { name: "pH", value: "8.0-9.0", unit: "" },
                    { name: "Hiding Power", value: "â¥98%", unit: "Contrast ratio" },
                    { name: "Lightfastness", value: "â¥7", unit: "Blue wool scale" }
                ],
                automotive_paint: [
                    { name: "Color Accuracy", value: "ÎE <0.5", unit: "CIE Lab" },
                    { name: "Gloss Level", value: "85-95", unit: "60Â° angle" },
                    { name: "Hardness", value: "â¥2H", unit: "Pencil test" },
                    { name: "UV Resistance", value: "â¥1000", unit: "hours QUV" },
                    { name: "Color Retention", value: "ÎE<2", unit: "After 1000h" },
                    { name: "Metamerism", value: "Grade A", unit: "D65/A illuminants" }
                ]
            };
            
            const appParams = parameters[application] || parameters.emulsion_paint;
            qcContainer.innerHTML = appParams.map(param => `
                <div class="bg-gray-50 p-3 rounded border border-gray-200">
                    <div class="text-xs text-gray-600 font-medium">${param.name}</div>
                    <div class="font-semibold text-lg text-gray-900">${param.value}</div>
                    <div class="text-xs text-gray-500">${param.unit}</div>
                </div>
            `).join('');
        }

        // Utility functions
        function updateColorInfo(hex) {
            document.getElementById('hexValue').textContent = hex;
            document.getElementById('rgbValue').textContent = hexToRgb(hex);
            generateShadeVariations(hex);
        }

        function hexToRgb(hex) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `${r}, ${g}, ${b}`;
        }

        function generateShadeVariations(hex) {
            const shadeCards = document.getElementById('shadeCards');
            if (!shadeCards) return;
            
            const variations = [];
            
            for (let i = -2; i <= 2; i++) {
                if (i === 0) {
                    variations.push({ color: hex, label: 'Base Color', type: 'base' });
                } else {
                    const factor = i > 0 ? 1 + (i * 0.3) : 1 + (i * 0.2);
                    const newColor = adjustBrightness(hex, factor);
                    const label = i > 0 ? `+${i * 30}% Lighter` : `${Math.abs(i) * 20}% Darker`;
                    variations.push({ color: newColor, label, type: i > 0 ? 'light' : 'dark' });
                }
            }
            
            shadeCards.innerHTML = variations.map(variation => `
                <div class="color-card transition-all duration-200 cursor-pointer p-3 rounded-lg border border-gray-200 hover:shadow-md"
                     onclick="selectShade('${variation.color}')">
                    <div class="w-full h-16 rounded mb-2" style="background-color: ${variation.color}"></div>
                    <div class="text-xs text-center">
                        <div class="font-medium">${variation.label}</div>
                        <div class="text-gray-500 font-mono">${variation.color}</div>
                    </div>
                </div>
            `).join('');
        }

        function adjustBrightness(hex, factor) {
            const r = Math.min(255, Math.max(0, Math.round(parseInt(hex.slice(1, 3), 16) * factor)));
            const g = Math.min(255, Math.max(0, Math.round(parseInt(hex.slice(3, 5), 16) * factor)));
            const b = Math.min(255, Math.max(0, Math.round(parseInt(hex.slice(5, 7), 16) * factor)));
            
            return '#' + [r, g, b].map(x => {
                const hex = x.toString(16);
                return hex.length === 1 ? '0' + hex : hex;
            }).join('');
        }

        function selectShade(color) {
            document.getElementById('baseColor').value = color;
            updateColorInfo(color);
            const application = document.getElementById('applicationType').value;
            const batchSize = parseInt(document.getElementById('batchSize').value);
            const qualityGrade = document.getElementById('qualityGrade').value;
            generateScientificFormulation(color, application, batchSize, qualityGrade);
            addConsoleMessage(`Scientific shade analysis: ${color} selected by yashmgupta`);
        }

        function addToPalette(color) {
            const paletteContainer = document.getElementById('colorPalette');
            const paletteCount = document.getElementById('paletteCount');
            
            let savedColors = JSON.parse(localStorage.getItem('pigmentProColors') || '[]');
            
            if (!savedColors.some(c => c.color === color)) {
                const colorData = {
                    color: color,
                    timestamp: new Date().toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' }),
                    application: document.getElementById('applicationType').value,
                    batchSize: document.getElementById('batchSize').value,
                    qualityGrade: document.getElementById('qualityGrade').value,
                    user: 'yashmgupta',
                    scientificAnalysis: colorScience.getDetailedColorClassification(
                        parseInt(color.slice(1, 3), 16),
                        parseInt(color.slice(3, 5), 16),
                        parseInt(color.slice(5, 7), 16)
                    ).shadeClassification
                };
                savedColors.unshift(colorData);
                savedColors = savedColors.slice(0, 10);
                localStorage.setItem('pigmentProColors', JSON.stringify(savedColors));
            }
            
            displayPalette(savedColors);
            paletteCount.textContent = `${savedColors.length} colors`;
        }

        function displayPalette(colors) {
            const paletteContainer = document.getElementById('colorPalette');
            
            if (colors.length === 0) {
                paletteContainer.innerHTML = '<p class="text-sm text-gray-500">No recent formulations yet</p>';
                return;
            }
            
            paletteContainer.innerHTML = colors.map(colorData => `
                <div class="flex items-center space-x-3 p-2 rounded hover:bg-gray-50 cursor-pointer transition-colors"
                     onclick="loadSavedColor('${colorData.color}', '${colorData.application}', '${colorData.qualityGrade}')">
                    <div class="w-8 h-8 rounded border border-gray-200 shadow-sm" style="background-color: ${colorData.color}"></div>
                    <div class="flex-1 min-w-0">
                        <div class="text-sm font-medium text-gray-900">${colorData.color}</div>
                        <div class="text-xs text-gray-500">${colorData.application} â¢ ${colorData.batchSize}kg â¢ ${colorData.qualityGrade}</div>
                        <div class="text-xs text-blue-600">${colorData.scientificAnalysis ? colorData.scientificAnalysis.replace(/_/g, ' ') : 'Scientific'}</div>
                        <div class="text-xs text-gray-400">${colorData.timestamp}</div>
                    </div>
                </div>
            `).join('');
        }

        function loadSavedColor(color, application, qualityGrade) {
            document.getElementById('baseColor').value = color;
            document.getElementById('applicationType').value = application;
            document.getElementById('qualityGrade').value = qualityGrade;
            updateColorInfo(color);
            const batchSize = parseInt(document.getElementById('batchSize').value);
            generateScientificFormulation(color, application, batchSize, qualityGrade);
            addConsoleMessage(`Scientific formulation loaded: ${color} for ${application} by yashmgupta`);
        }

        function addConsoleMessage(message) {
            const console = document.getElementById('console');
            const timestamp = new Date().toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' });
            const newMessage = document.createElement('p');
            newMessage.innerHTML = `<span class="text-gray-500">[${timestamp}]</span> > ${message}`;
            console.appendChild(newMessage);
            console.scrollTop = console.scrollHeight;
            
            while (console.children.length > 50) {
                console.removeChild(console.firstChild);
            }
        }

        function updateDateTime() {
            const now = new Date();
            const options = { 
                timeZone: 'UTC',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            };
            document.getElementById('datetime').textContent = now.toLocaleString('en-CA', options).replace(/[^\d\-\s:]/g, '').replace(' ', ' ') + ' UTC';
        }

        // Export and Print Functions
        function exportFormulation() {
            const color = document.getElementById('baseColor').value;
            const application = document.getElementById('applicationType').value;
            const batchSize = document.getElementById('batchSize').value;
            const qualityGrade = document.getElementById('qualityGrade').value;
            
            const r = parseInt(color.slice(1, 3), 16);
            const g = parseInt(color.slice(3, 5), 16);
            const b = parseInt(color.slice(5, 7), 16);
            const scientificAnalysis = colorScience.getDetailedColorClassification(r, g, b);
            
            const exportData = {
                timestamp: "2025-06-03T03:32:28.000Z",
                color: color,
                application: application,
                batchSize: batchSize,
                qualityGrade: qualityGrade,
                scientificAnalysis: scientificAnalysis,
                formulaData: getCurrentFormula(),
                developer: "Dr. Yash M Gupta",
                system: "PigmentPro Advanced Scientific Formulation System v8.0.0",
                user: "yashmgupta",
                generatedDate: "2025-06-03",
                metadata: {
                    totalComponents: getCurrentFormula().length,
                    shadeSpecific: true,
                    scientificCalculations: true,
                    kubelkaMunkTheory: true,
                    colorSpaceAnalysis: "LAB, HSL, Chroma",
                    bisStandards: "IS 2339:2018"
                }
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `PigmentPro_Scientific_${color.replace('#', '')}_${scientificAnalysis.shadeClassification}_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            
            addConsoleMessage(`Scientific formulation exported by yashmgupta: ${link.download}`);
        }

        function printFormulation() {
            const printWindow = window.open('', '_blank');
            const color = document.getElementById('baseColor').value;
            const application = document.getElementById('applicationType').value;
            const batchSize = document.getElementById('batchSize').value;
            const qualityGrade = document.getElementById('qualityGrade').value;
            const formula = getCurrentFormula();
            
            const r = parseInt(color.slice(1, 3), 16);
            const g = parseInt(color.slice(3, 5), 16);
            const b = parseInt(color.slice(5, 7), 16);
            const scientificAnalysis = colorScience.getDetailedColorClassification(r, g, b);
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>PigmentPro Scientific Formulation Report</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.4; }
                        .header { border-bottom: 3px solid #333; padding-bottom: 15px; margin-bottom: 25px; }
                        .color-swatch { width: 60px; height: 60px; border: 2px solid #ccc; display: inline-block; margin-right: 20px; border-radius: 8px; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; font-size: 11px; }
                        th, td { border: 1px solid #ddd; padding: 6px; text-align: left; }
                        th { background-color: #f8f9fa; font-weight: bold; }
                        .category-header { background-color: #3b82f6; color: white; font-weight: bold; text-align: center; }
                        .footer { margin-top: 40px; font-size: 11px; color: #666; border-top: 1px solid #ddd; padding-top: 15px; }
                        .scientific-data { background-color: #f0f9ff; padding: 15px; border-radius: 8px; margin: 20px 0; }
                        .watermark { position: fixed; bottom: 50px; right: 50px; opacity: 0.1; font-size: 24px; font-weight: bold; }
                    </style>
                </head>
                <body>
                    <div class="watermark">Dr. Yash M Gupta</div>
                    
                    <div class="header">
                        <h1>PigmentPro Scientific Formulation Report</h1>
                        <p><strong>Developed by:</strong> Dr. Yash M Gupta</p>
                        <p><strong>System:</strong> PigmentPro Advanced Scientific Formulation System v8.0.0</p>
                        <p><strong>User:</strong> yashmgupta</p>
                        <p><strong>Generated:</strong> 2025-06-03 03:32:28 UTC</p>
                    </div>
                    
                    <div style="display: flex; align-items: center; margin: 25px 0;">
                        <div class="color-swatch" style="background-color: ${color};"></div>
                        <div>
                            <h2 style="margin: 0;">Target Color: ${color}</h2>
                            <p style="margin: 5px 0;"><strong>Application:</strong> ${application}</p>
                            <p style="margin: 5px 0;"><strong>Batch Size:</strong> ${batchSize} kg</p>
                            <p style="margin: 5px 0;"><strong>Quality Grade:</strong> ${qualityGrade}</p>
                        </div>
                    </div>
                    
                    <div class="scientific-data">
                        <h3>Scientific Color Analysis</h3>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
                            <div><strong>Shade Classification:</strong><br>${scientificAnalysis.shadeClassification.replace(/_/g, ' ').toUpperCase()}</div>
                            <div><strong>Color Strength:</strong><br>${scientificAnalysis.colorStrength.replace(/_/g, ' ').toUpperCase()}</div>
                            <div><strong>LAB Values:</strong><br>L:${scientificAnalysis.lab.L} a:${scientificAnalysis.lab.a} b:${scientificAnalysis.lab.b}</div>
                            <div><strong>Chroma:</strong><br>${scientificAnalysis.chroma}</div>
                        </div>
                        <p style="margin-top: 10px; font-style: italic;">
                            <strong>Scientific Method:</strong> Formulation calculated using Kubelka-Munk color matching theory 
                            with precise pigment selection based on shade-specific requirements.
                        </p>
                    </div>
                    
                    <h3>Complete Scientific Formulation</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Component Name</th>
                                <th>Chemical Formula</th>
                                <th>Indian Supplier</th>
                                <th>Weight (g)</th>
                                <th>Percentage (%)</th>
                                <th>Function</th>
                                <th>Grade/Specification</th>
                                <th>Cost (â¹)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${formula.map(item => {
                                if (item.category && item.category.includes('COMPONENTS')) {
                                    return `<tr class="category-header"><td colspan="8">${item.category}</td></tr>`;
                                } else {
                                    return `
                                        <tr>
                                            <td>${item.component}</td>
                                            <td>${item.chemicalFormula}</td>
                                            <td>${item.supplier}</td>
                                            <td>${item.weight}</td>
                                            <td>${item.percentage || ''}</td>
                                            <td>${item.function}</td>
                                            <td>${item.grade}</td>
                                            <td>${item.cost || ''}</td>
                                        </tr>
                                    `;
                                }
                            }).join('')}
                        </tbody>
                    </table>
                    
                    <div class="footer">
                        <p><strong>Generated by PigmentPro Advanced Scientific Formulation System v8.0.0</strong></p>
                        <p>Â© 2025 Dr. Yash M Gupta | All rights reserved</p>
                        <p>Scientific formulation based on shade-specific analysis and Kubelka-Munk theory</p>
                        <p>Compliant with Indian market standards and BIS specifications</p>
                        <p>User: yashmgupta | Generated: 2025-06-03 03:32:28 UTC</p>
                        <p><em>Note: This formulation uses advanced color science calculations for precise shade matching and optimal pigment selection.</em></p>
                    </div>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.print();
        }

        function getCurrentFormula() {
            const rows = document.querySelectorAll('#formulaContent tr');
            const formula = [];
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 7) {
                    if (cells.length === 8) {
                        formula.push({
                            component: cells[0].textContent,
                            chemicalFormula: cells[1].textContent,
                            supplier: cells[2].textContent,
                            weight: cells[3].textContent,
                            percentage: cells[4].textContent,
                            function: cells[5].textContent,
                            grade: cells[6].textContent,
                            cost: cells[7].textContent
                        });
                    } else if (cells.length === 1 && cells[0].getAttribute('colspan') === '8') {
                        formula.push({
                            category: cells[0].textContent,
                            component: '', chemicalFormula: '', supplier: '',
                            weight: '', percentage: '', function: '', grade: '', cost: ''
                        });
                    }
                }
            });
            return formula;
        }

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            updateDateTime();
            setInterval(updateDateTime, 1000);
            
            const savedColors = JSON.parse(localStorage.getItem('pigmentProColors') || '[]');
            displayPalette(savedColors);
            document.getElementById('paletteCount').textContent = `${savedColors.length} colors`;
            
            updateColorInfo('#dc2626');
            generateScientificFormulation('#dc2626', 'emulsion_paint', 1, 'standard');
            
            // Event listeners
            document.getElementById('baseColor').addEventListener('input', function() {
                const color = this.value;
                updateColorInfo(color);
                const application = document.getElementById('applicationType').value;
                const batchSize = parseInt(document.getElementById('batchSize').value);
                const qualityGrade = document.getElementById('qualityGrade').value;
                generateScientificFormulation(color, application, batchSize, qualityGrade);
            });
            
            ['applicationType', 'batchSize', 'qualityGrade'].forEach(id => {
                document.getElementById(id).addEventListener('change', function() {
                    const color = document.getElementById('baseColor').value;
                    const application = document.getElementById('applicationType').value;
                    const batchSize = parseInt(document.getElementById('batchSize').value);
                    const qualityGrade = document.getElementById('qualityGrade').value;
                    generateScientificFormulation(color, application, batchSize, qualityGrade);
                    addConsoleMessage(`Parameter optimized by yashmgupta: ${id} = ${this.value}`);
                });
            });
            
            document.getElementById('formulateBtn').addEventListener('click', function() {
                const color = document.getElementById('baseColor').value;
                const application = document.getElementById('applicationType').value;
                const batchSize = parseInt(document.getElementById('batchSize').value);
                const qualityGrade = document.getElementById('qualityGrade').value;
                generateScientificFormulation(color, application, batchSize, qualityGrade);
            });
            
            document.getElementById('randomBtn').addEventListener('click', function() {
                const randomColor = '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0');
                document.getElementById('baseColor').value = randomColor;
                updateColorInfo(randomColor);
                const application = document.getElementById('applicationType').value;
                const batchSize = parseInt(document.getElementById('batchSize').value);
                const qualityGrade = document.getElementById('qualityGrade').value;
                generateScientificFormulation(randomColor, application, batchSize, qualityGrade);
                addConsoleMessage(`Random scientific analysis initiated by yashmgupta: ${randomColor}`);
            });
            
            document.getElementById('saveBtn').addEventListener('click', function() {
                const color = document.getElementById('baseColor').value;
                addToPalette(color);
                addConsoleMessage(`Scientific formulation saved by yashmgupta: ${color}`);
            });
            
            document.getElementById('resetBtn').addEventListener('click', function() {
                document.getElementById('baseColor').value = '#dc2626';
                document.getElementById('applicationType').value = 'emulsion_paint';
                document.getElementById('batchSize').value = '1';
                document.getElementById('qualityGrade').value = 'standard';
                updateColorInfo('#dc2626');
                generateScientificFormulation('#dc2626', 'emulsion_paint', 1, 'standard');
                addConsoleMessage("Scientific system reset by yashmgupta");
            });

            document.getElementById('printBtn').addEventListener('click', printFormulation);
            document.getElementById('exportBtn').addEventListener('click', exportFormulation);

            // Welcome messages
            addConsoleMessage("PigmentPro Advanced Scientific Formulation System Ready");
            addConsoleMessage("User: yashmgupta authenticated successfully");
            addConsoleMessage("Advanced color science engine: ACTIVE");
            addConsoleMessage("Kubelka-Munk calculations: ENABLED");
            addConsoleMessage("Shade-specific algorithms: LOADED");
            addConsoleMessage("Ready for precision scientific formulation by Dr. Yash M Gupta");
        });

    </script>
</body>
</html>
